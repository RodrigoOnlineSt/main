<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Portal de P√°ginas</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { background: #f8fafc; margin:0; font-family:'Segoe UI',Arial,sans-serif; color:#222;}
    .container { max-width: 440px; margin:38px auto 0; background:#fff; border-radius:17px; box-shadow:0 4px 18px #0002; }
    .header { padding:24px 8px 12px 8px; background:linear-gradient(100deg,#21a2ee 70%,#144a6b); border-radius:17px 17px 0 0; text-align:center; font-size:1.25em; font-weight:600; color:#fff;}
    .list { margin:16px 0 0 0; padding:0 14px 12px 14px; }
    .page-link { display:flex;align-items:center;justify-content:space-between; background:#e7f3fb; border-radius:10px; padding:13px 18px; margin-bottom:12px; font-size:1.1em; box-shadow:0 2px 7px #0012;}
    .page-link a { color:#144a6b; text-decoration:none; font-weight:600;}
    @media (max-width: 560px){ .container{max-width:99vw;} .header{font-size:1.09em;} }
    .anexos-list span { display:block; margin-bottom:2px;font-size:0.98em;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      Portal de P√°ginas <span style="font-size:0.9em;font-weight:400;">(visualiza√ß√£o)</span>
    </div>
    <div class="list" id="pagesList"></div>
  </div>
  <script>
    // MESMO firebaseConfig do admin!
    const firebaseConfig = {
      apiKey: "AIzaSyAr-qpOVl3aooDY56W9fHHLmmIxfms1P5I",
      authDomain: "presta-9f617.firebaseapp.com",
      projectId: "presta-9f617",
      storageBucket: "presta-9f617.appspot.com",
      messagingSenderId: "933441693460",
      appId: "1:933441693460:web:d1685236428060f700c401",
      measurementId: "G-G4BNHYSYM6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Se abrir com ?pg=, mostra p√°gina individual + anexos
    async function openPage(){
      const params = new URLSearchParams(location.search);
      const pgId = params.get('pg');
      if(pgId){
        const doc = await db.collection('pages').doc(pgId).get();
        if(doc.exists){
          const p = doc.data();
          let anexosHtml = '';
          if(p.anexos && p.anexos.length){
            anexosHtml = '<div class="anexos-list" style="margin:16px 0 10px 0;">';
            p.anexos.forEach(a=>{
              if(a.type.startsWith("image/")){
                anexosHtml += `<span>üñºÔ∏è<br><img src="${a.url}" alt="${a.name}" style="max-width:100%;max-height:220px;display:block;margin:4px auto 10px auto;border-radius:8px;"></span>`;
              } else if(a.type.startsWith("audio/")){
                anexosHtml += `<span>üîä<br><audio controls src="${a.url}" style="width:100%;"></audio></span>`;
              } else if(a.type.startsWith("video/")){
                anexosHtml += `<span>üé¨<br><video controls src="${a.url}" style="width:100%;max-height:240px;border-radius:7px;margin:6px 0;" controls></video></span>`;
              } else if(a.type.includes("pdf")){
                anexosHtml += `<span>üìÑ <a href="${a.url}" target="_blank">${a.name}</a></span>`;
              } else {
                anexosHtml += `<span>üìé <a href="${a.url}" target="_blank">${a.name}</a></span>`;
              }
            });
            anexosHtml += '</div>';
          }
          document.body.innerHTML = `
            <div class="container" style="margin-top:28px;">
              <div class="header" style="margin-bottom:9px;">
                ${p.name}
                <div style="font-size:0.93em;font-weight:400;color:#e5f6ff;">P√°gina completa</div>
              </div>
              <div style="padding:13px;">
                <div style="background:#f8fafc;border-radius:10px;padding:10px;margin-bottom:13px;">
                  <b>HTML desta p√°gina:</b><br>
                  <iframe style="width:100%;min-height:200px;border-radius:7px;background:#fff;" srcdoc="${encodeURIComponent(p.html)}"></iframe>
                </div>
                <b>Anexos:</b>
                ${anexosHtml || '<span style="color:#bbb;">Nenhum anexo</span>'}
                <div style="text-align:center;margin:22px 0 4px 0;">
                  <a href="portal.html" style="background:#1694b7;color:#fff;border-radius:8px;padding:10px 20px;text-decoration:none;font-weight:600;">‚¨Ö Voltar ao Portal</a>
                </div>
              </div>
            </div>
          `;
        }else{
          document.body.innerHTML = `<div class="container"><div class="header">P√°gina n√£o encontrada</div></div>`;
        }
      }
    }
    // Se for p√°gina individual, mostra s√≥ ela
    if(location.search.includes("pg=")){
      openPage();
    } else {
      // Listagem de todas as p√°ginas (real time)
      db.collection('pages').orderBy('created', 'desc').onSnapshot((snap)=>{
        const list = document.getElementById('pagesList');
        let html = '';
        snap.forEach(doc=>{
          const p = doc.data();
          html += `
            <div class="page-link">
              <a href="portal.html?pg=${doc.id}">${p.name}</a>
              <span style="font-size:0.92em;color:#888">${p.anexos?.length||0} arquivos</span>
            </div>
          `;
        });
        list.innerHTML = html || '<div style="text-align:center;color:#888;margin:24px 0;">Nenhuma p√°gina dispon√≠vel.</div>';
      });
    }
  </script>
</body>
</html>
